<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>P&K Store - MLBB Diamond Top-Up</title>
  <link rel="icon" type="image/png" href="https://i.ibb.co/TxRTR7gK/Screenshot-2025-07-02-093146.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* [Previous CSS styles remain exactly the same] */
  </style>
</head>
<body>
  <!-- [Previous HTML structure remains exactly the same until the script section] -->

  <script>
    // Google Drive API configuration
    const CLIENT_ID = '856647789843-teunsdqh8coqkicbq1rhgnesqpr5stkl.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyCMMO6AA43G7XAhXIZ3kn4E_zdOMzpkfLg';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const FOLDER_NAME = 'PKStoreData';
    const USERS_FILE_NAME = 'users.json';
    const ORDERS_FILE_NAME = 'orders.json';

    // Sample data structure
    let appData = {
      users: [],
      orders: []
    };

    // DOM Elements [Previous DOM element declarations remain the same]

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
      // Generate package cards
      generatePackageCards();
      
      // Event listeners [Previous event listeners remain the same]
      
      // Initialize Google API client
      initGoogleClient();
    });

    // Initialize Google API client
    function initGoogleClient() {
      gapi.load('client:auth2', () => {
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(() => {
          // Listen for sign-in state changes
          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
          // Handle initial sign-in state
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        }).catch(err => {
          console.error('Error initializing Google API:', err);
          showNotification('Failed to initialize Google Drive connection', 'error');
        });
      });
    }

    // Update UI based on sign-in status
    function updateSigninStatus(isSignedIn) {
      const syncStatus = document.getElementById('sync-status');
      const connectBtn = document.getElementById('connect-drive-btn');
      
      if (isSignedIn) {
        syncStatus.textContent = 'ðŸŸ¢ Connected to Drive';
        syncStatus.className = 'sync-status connected';
        connectBtn.textContent = 'Disconnect';
        connectBtn.onclick = handleSignout;
        
        // Load data from Drive
        loadDataFromDrive();
      } else {
        syncStatus.textContent = 'ðŸ”´ Not Connected';
        syncStatus.className = 'sync-status disconnected';
        connectBtn.textContent = 'Connect Drive';
        connectBtn.onclick = handleAuthClick;
      }
    }

    // Handle Google Drive sign-in
    function handleAuthClick() {
      gapi.auth2.getAuthInstance().signIn();
    }

    // Handle Google Drive sign-out
    function handleSignout() {
      gapi.auth2.getAuthInstance().signOut();
    }

    // Create folder in Google Drive if it doesn't exist
    async function ensureDataFolder() {
      try {
        const response = await gapi.client.drive.files.list({
          q: `name='${FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
          fields: 'files(id)'
        });
        
        if (response.result.files.length > 0) {
          return response.result.files[0].id;
        } else {
          const folder = await gapi.client.drive.files.create({
            resource: {
              name: FOLDER_NAME,
              mimeType: 'application/vnd.google-apps.folder'
            },
            fields: 'id'
          });
          return folder.result.id;
        }
      } catch (err) {
        console.error('Error creating folder:', err);
        throw err;
      }
    }

    // Save data to Google Drive
    async function saveDataToDrive() {
      try {
        const folderId = await ensureDataFolder();
        
        // Check if files exist
        const usersFileResponse = await gapi.client.drive.files.list({
          q: `name='${USERS_FILE_NAME}' and '${folderId}' in parents and trashed=false`,
          fields: 'files(id)'
        });
        
        const ordersFileResponse = await gapi.client.drive.files.list({
          q: `name='${ORDERS_FILE_NAME}' and '${folderId}' in parents and trashed=false`,
          fields: 'files(id)'
        });
        
        // Convert data to JSON
        const usersJson = JSON.stringify(appData.users);
        const ordersJson = JSON.stringify(appData.orders);
        
        // Prepare file metadata
        const usersMetadata = {
          name: USERS_FILE_NAME,
          mimeType: 'application/json',
          parents: [folderId]
        };
        
        const ordersMetadata = {
          name: ORDERS_FILE_NAME,
          mimeType: 'application/json',
          parents: [folderId]
        };
        
        // Prepare file content
        const usersContent = new Blob([usersJson], {type: 'application/json'});
        const ordersContent = new Blob([ordersJson], {type: 'application/json'});
        
        // Create or update files
        if (usersFileResponse.result.files.length > 0) {
          // Update existing file
          await gapi.client.drive.files.update({
            fileId: usersFileResponse.result.files[0].id,
            media: {
              mimeType: 'application/json',
              body: usersContent
            }
          });
        } else {
          // Create new file
          await gapi.client.drive.files.create({
            resource: usersMetadata,
            media: {
              mimeType: 'application/json',
              body: usersContent
            }
          });
        }
        
        if (ordersFileResponse.result.files.length > 0) {
          // Update existing file
          await gapi.client.drive.files.update({
            fileId: ordersFileResponse.result.files[0].id,
            media: {
              mimeType: 'application/json',
              body: ordersContent
            }
          });
        } else {
          // Create new file
          await gapi.client.drive.files.create({
            resource: ordersMetadata,
            media: {
              mimeType: 'application/json',
              body: ordersContent
            }
          });
        }
        
        showNotification('Data saved to Google Drive successfully!', 'success');
        return true;
      } catch (err) {
        console.error('Error saving to Drive:', err);
        showNotification('Failed to save data to Google Drive', 'error');
        return false;
      }
    }

    // Load data from Google Drive
    async function loadDataFromDrive() {
      try {
        const folderId = await ensureDataFolder();
        
        // Get users file
        const usersFileResponse = await gapi.client.drive.files.list({
          q: `name='${USERS_FILE_NAME}' and '${folderId}' in parents and trashed=false`,
          fields: 'files(id)'
        });
        
        // Get orders file
        const ordersFileResponse = await gapi.client.drive.files.list({
          q: `name='${ORDERS_FILE_NAME}' and '${folderId}' in parents and trashed=false`,
          fields: 'files(id)'
        });
        
        if (usersFileResponse.result.files.length > 0) {
          const usersFile = await gapi.client.drive.files.get({
            fileId: usersFileResponse.result.files[0].id,
            alt: 'media'
          });
          appData.users = usersFile.result;
        }
        
        if (ordersFileResponse.result.files.length > 0) {
          const ordersFile = await gapi.client.drive.files.get({
            fileId: ordersFileResponse.result.files[0].id,
            alt: 'media'
          });
          appData.orders = ordersFile.result;
        }
        
        showNotification('Data loaded from Google Drive successfully!', 'success');
        
        // Update UI if admin is logged in
        if (currentUser && currentUser.role === 'admin') {
          loadAdminData();
        }
        
        return true;
      } catch (err) {
        console.error('Error loading from Drive:', err);
        showNotification('Failed to load data from Google Drive', 'error');
        return false;
      }
    }

    // [Previous functions remain the same until handleLogin]

    // Handle login - updated to use Drive data
    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      // Simple validation
      if (!username || !password) {
        showNotification('Please enter both username and password', 'error');
        return;
      }
      
      // Check against Drive data
      const user = appData.users.find(u => u.username === username && u.password === password);
      
      if (user) {
        // Successful login
        currentUser = user;
        showNotification('Login successful!', 'success');
        
        // Update UI
        currentUserSpan.textContent = user.username;
        userRoleSpan.textContent = user.role;
        
        // Show admin button if admin
        if (user.role === 'admin') {
          adminPanelBtn.classList.remove('hidden');
        } else {
          adminPanelBtn.classList.add('hidden');
        }
        
        // Switch to store content
        loginSection.classList.add('hidden');
        storeContent.classList.remove('hidden');
      } else {
        showNotification('Invalid username or password', 'error');
      }
    }

    // Handle register - updated to save to Drive
    function handleRegister(e) {
      e.preventDefault();
      const username = document.getElementById('reg-username').value;
      const password = document.getElementById('reg-password').value;
      const confirm = document.getElementById('reg-confirm').value;
      
      // Validation
      if (!username || !password || !confirm) {
        showNotification('Please fill all fields', 'error');
        return;
      }
      
      if (password !== confirm) {
        showNotification('Passwords do not match', 'error');
        return;
      }
      
      // Check if user exists
      const userExists = appData.users.some(u => u.username === username);
      if (userExists) {
        showNotification('Username already exists', 'error');
        return;
      }
      
      // Add new user
      appData.users.push({ 
        username, 
        password, // Note: In production, you should hash passwords!
        role: 'customer' 
      });
      
      // Save to Drive
      saveDataToDrive().then(() => {
        showNotification('Account created successfully! Please login', 'success');
        hideRegisterModal();
        loginForm.reset();
      });
    }

    // Handle add user - updated to save to Drive
    function handleAddUser() {
      const username = document.getElementById('admin-username').value;
      const password = document.getElementById('admin-password').value;
      const role = document.getElementById('admin-role').value;
      
      if (!username || !password || !role) {
        showNotification('Please fill all fields', 'error');
        return;
      }
      
      // Check if user exists
      const userExists = appData.users.some(u => u.username === username);
      if (userExists) {
        showNotification('Username already exists', 'error');
        return;
      }
      
      // Add new user
      appData.users.push({ username, password, role });
      
      // Save to Drive and update UI
      saveDataToDrive().then(() => {
        loadAdminData();
        showNotification('User added successfully', 'success');
        
        // Clear form
        document.getElementById('admin-username').value = '';
        document.getElementById('admin-password').value = '';
        document.getElementById('admin-role').value = '';
      });
    }

    // Handle order submit - updated to save to Drive
    function handleOrderSubmit(e) {
      e.preventDefault();
      const pkg = document.getElementById('order-package').textContent;
      const price = document.getElementById('order-price').textContent;
      const mlbbId = document.getElementById('mlbb-id').value;
      const serverId = document.getElementById('server-id').value;
      const ign = document.getElementById('ign').value;
      
      if (!mlbbId || !serverId || !ign) {
        showNotification('Please fill all fields', 'error');
        return;
      }
      
      // Create order
      const newOrder = {
        id: `ORD-${Math.floor(1000 + Math.random() * 9000)}`,
        customer: currentUser.username,
        package: pkg,
        price: price,
        mlbbId: mlbbId,
        serverId: serverId,
        ign: ign,
        status: 'pending',
        date: new Date().toISOString()
      };
      
      // Add to orders
      appData.orders.unshift(newOrder);
      
      // Save to Drive
      saveDataToDrive().then(() => {
        // Open WhatsApp
        const orderDetails = `Order Details:
Package: ${pkg}
Price: ${price}
MLBB ID: ${mlbbId}
Server ID: ${serverId}
IGN: ${ign}`;
        
        const whatsappUrl = `https://wa.me/919362584929?text=${encodeURIComponent(orderDetails)}`;
        window.open(whatsappUrl, '_blank');
        
        showNotification('Order submitted successfully! Please send payment screenshot on WhatsApp', 'success');
        hideOrderModal();
        orderForm.reset();
      });
    }

    // [Rest of the previous functions remain the same]

    // Make functions available globally
    window.showOrderModal = showOrderModal;
    window.showWeeklyPassOrder = showWeeklyPassOrder;
    window.copyUpiId = copyUpiId;
  </script>
  
  <!-- Load Google API client -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
</body>
</html>
